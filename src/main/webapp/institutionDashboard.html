<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Institution Dashboard - Link-Work</title>
    <link rel="stylesheet" href="css/global.css?v=1">
    <link rel="stylesheet" href="css/dashboard.css?v=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Merriweather:wght@300;400;700;900&display=swap"
        rel="stylesheet">
</head>

<body>

    <header class="dash-header">
        <div class="dash-brand">Institution Dashboard</div>
        <form id="logoutForm" method="post" action="api/logout">
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </header>

    <div class="dash-nav-container">
        <nav class="dash-tabs">
            <button id="post-job" class="dash-tab active">
                <span class="tab-icon">+</span> Post Job
            </button>
            <button id="posted-jobs" class="dash-tab">
                <span class="tab-icon">ðŸ“‹</span> Posted Jobs
            </button>
            <button id="chat" class="dash-tab">
                <span class="tab-icon">ðŸ’¬</span> Chat <span id="unread-badge" class="badge"></span>
            </button>
        </nav>
    </div>

    <main id="content" class="dash-content">
    </main>

    <script>
        const content = document.getElementById('content');
        const postBtn = document.getElementById('post-job');
        const postedBtn = document.getElementById('posted-jobs');
        const chatBtn = document.getElementById('chat');

        let currentView = 'post';

        postBtn.addEventListener('click', () => {
            currentView = 'post';
            updateNav(postBtn);
            showPostForm();
        });

        postedBtn.addEventListener('click', () => {
            currentView = 'posted';
            updateNav(postedBtn);
            loadPostedJobs();
        });

        chatBtn.addEventListener('click', () => {
            window.location.href = 'chat.html?role=INSTITUTE';
        });

        function updateNav(activeBtn) {
            document.querySelectorAll('.dash-tab').forEach(btn => btn.classList.remove('active'));
            activeBtn.classList.add('active');
        }

        // Show job posting form
        function showPostForm() {
            content.innerHTML = `
                <div class="form-card">
                    <h2 class="form-title">Post a New Job</h2>
                    <form method="post" action="api/announcements">
                        <div class="dash-input-group">
                            <label class="dash-label">Job Title</label>
                            <input type="text" name="title" class="dash-input" placeholder="e.g., Senior React Developer" required>
                        </div>
                        <div class="dash-input-group">
                            <label class="dash-label">Description</label>
                            <textarea name="content" class="dash-input dash-textarea" placeholder="Describe the job requirements..." required></textarea>
                        </div>
                        <div class="dash-input-group">
                            <label class="dash-label">Budget</label>
                            <input type="text" name="budget" class="dash-input" placeholder="e.g., $5,000">
                        </div>
                        <button type="submit" class="btn btn-navy" style="width: 100%; padding: 1rem;">Post Job</button>
                    </form>
                </div>
            `;
        }

        // Load jobs I posted
        async function loadPostedJobs() {
            content.innerHTML = '<div style="text-align: center; color: #64748B;">Loading posted jobs...</div>';
            try {
                const res = await fetch('api/announcements?myJobs=true', { cache: 'no-cache' });
                if (!res.ok) {
                    content.innerHTML = '<div style="text-align: center; color: red;">Failed to load jobs.</div>';
                    return;
                }
                const jobs = await res.json();
                content.innerHTML = '';
                if (jobs.length === 0) {
                    content.innerHTML = '<div style="text-align: center; color: #64748B; margin-top: 2rem;">No posted jobs yet.</div>';
                    return;
                }

                jobs.forEach(job => {
                    const card = document.createElement('div');
                    card.className = 'job-card';
                    const applicants = Math.floor(Math.random() * 20);

                    card.innerHTML = `
                        <div class="job-info">
                            <h3>${job.title}</h3>
                            <p class="job-desc">${job.content.substring(0, 100)}${job.content.length > 100 ? '...' : ''}</p>
                            <div class="job-meta">
                                ${job.budget ? 'Budget: ' + job.budget : '$ Negotiable'}
                                <div class="job-posted-time">Posted recently</div>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.5rem; align-items:flex-end;">
                            <button class="btn btn-primary" style="font-size:0.9rem; padding:0.6rem 1.2rem;" onclick="viewApplicants(${job.id}, '${job.title.replace(/'/g, "\\'")}')">View Applicants</button>
                        </div>
                    `;
                    content.appendChild(card);
                });
            } catch (e) {
                console.error(e);
                content.innerHTML = '<div style="text-align: center; color: red;">Error loading jobs.</div>';
            }
        }

        // Show applicants for a job
        window.viewApplicants = function (jobId, jobTitle) {
            let modal = document.getElementById('applicantModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'applicantModal';
                modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:2000;backdrop-filter:blur(5px);';
                modal.innerHTML = `
                    <div style="background:white;padding:2rem;border-radius:12px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;position:relative;box-shadow:0 20px 50px rgba(0,0,0,0.2);">
                        <button onclick="document.getElementById('applicantModal').style.display='none'" style="position:absolute;top:15px;right:15px;border:none;background:none;font-size:1.5rem;cursor:pointer;color:#64748B;">&times;</button>
                        <h2 class="form-title" style="font-size:1.5rem;margin-bottom:1.5rem;border-bottom:1px solid #E2E8F0;padding-bottom:1rem;">Applicants for <br><span id="modalJobTitle" style="color:var(--color-accent);font-size:1.2rem;"></span></h2>
                        <div id="applicantList" style="display:flex;flex-direction:column;gap:1rem;"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('modalJobTitle').innerText = jobTitle;
            const list = document.getElementById('applicantList');
            list.innerHTML = '<div style="text-align:center;padding:2rem;">Loading...</div>';
            modal.style.display = 'flex';

            fetch('api/applicants?jobId=' + jobId)
                .then(res => res.json())
                .then(applicants => {
                    list.innerHTML = '';
                    if (applicants.length === 0) {
                        list.innerHTML = '<div style="text-align:center;padding:2rem;color:#64748B;">No applicants yet.</div>';
                        return;
                    }
                    applicants.forEach(app => {
                        const item = document.createElement('div');
                        item.style.cssText = 'padding:1rem;border:1px solid #E2E8F0;border-radius:8px;display:flex;justify-content:space-between;align-items:center;transition:background 0.2s;';
                        item.onmouseover = () => item.style.background = '#F8FAFC';
                        item.onmouseout = () => item.style.background = 'white';

                        item.innerHTML = `
                            <div>
                                <strong style="color:var(--color-primary-dark);">${app.name}</strong>
                                <div style="font-size:0.85rem;color:#64748B;">${app.email}</div>
                                <div style="font-size:0.75rem;color:#94A3B8;margin-top:0.2rem;">Applied: ${new Date(app.appliedAt).toLocaleDateString()}</div>
                            </div>
                            <button class="btn btn-primary" style="padding:0.5rem 1rem;font-size:0.8rem;" onclick="startChat(${app.id})">Message</button>
                        `;
                        list.appendChild(item);
                    });
                })
                .catch(err => {
                    list.innerHTML = '<div style="text-align:center;color:red;">Error loading applicants.</div>';
                });
        };

        window.startChat = function (userId) {
            fetch('api/chat/conversations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'otherUserId=' + userId
            })
                .then(res => res.json())
                .then(data => {
                    window.location.href = 'chat.html?role=INSTITUTE&conversationId=' + data.conversationId;
                })
                .catch(err => alert('Error starting chat'));
        };
        showPostForm();
        checkUnread();
        setInterval(checkUnread, 10000);

        async function checkUnread() {
            try {
                const res = await fetch('api/chat/unread');
                if (res.ok) {
                    const data = await res.json();
                    const badge = document.getElementById('unread-badge');
                    if (data.unreadCount > 0) {
                        badge.textContent = data.unreadCount;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    console.log('Unread API failed:', res.status);
                }
            } catch (err) {
                console.error('Unread check error:', err);
            }
        }
    </script>
    <script src="js/toast.js"></script>
</body>

</html>